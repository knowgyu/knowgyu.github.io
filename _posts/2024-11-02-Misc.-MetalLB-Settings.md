---
title: "Misc. MetalLB Settings"
author: knowgyu
description: " "
date: 2023-11-26 05:46:15 +0900
math: true
categories: [MLOps, Kubeflow-Pipeline]
tags: [MLOps, Kubeflow]
---

ë³¸ í˜ì´ì§€ì—ì„œëŠ” ë² ì–´ë©”íƒˆ í´ëŸ¬ìŠ¤í„°ìš© ë¡œë“œë°¸ëŸ°ì„œ MetalLB ì„¤ì¹˜ ë° ì„¤ì •ì— ëŒ€í•´ ë‹¤ë£¨ê² ìŠµë‹ˆë‹¤.

# Load Balancer

---

ë¡œë“œ ë°¸ëŸ°ì„œë€? ë„¤íŠ¸ì›Œí¬ íŠ¸ë˜í”½ì„ ì—¬ëŸ¬ ì„œë²„ì— ë¶„ì‚°ì‹œí‚¤ëŠ” ì—­í• ì…ë‹ˆë‹¤.

> *ë¶€í•˜ ë¶„ì‚°*ì€ ë°± ì—”ë“œ ì„œë²„ ë˜ëŠ” ë¦¬ì†ŒìŠ¤ì˜ ê·¸ë£¹ì—ì„œ ë“¤ì–´ì˜¤ëŠ” ë„¤íŠ¸ì›Œí¬ íŠ¸ë˜í”½ì„ íš¨ìœ¨ì ìœ¼ë¡œ ë¶„ì‚°í•˜ëŠ” ê²ƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤.<br>
[https://learn.microsoft.com/ko-kr/azure/load-balancer/load-balancer-overview](https://learn.microsoft.com/ko-kr/azure/load-balancer/load-balancer-overview)

ì¿ ë²„ë„¤í‹°ìŠ¤ ì‚¬ìš© ì‹œ AWS, GCP, Azureì™€ ê°™ì€ í´ë¼ìš°ë“œ í”Œë«í¼ì—ì„œëŠ” ìì²´ì ìœ¼ë¡œ ë¡œë“œ ë°¸ëŸ°ì„œë¥¼ ì œê³µí•˜ì§€ë§Œ,

ì˜¨ í”„ë ˆë¯¸ìŠ¤ í´ëŸ¬ìŠ¤í„°ì—ì„  ë¡œë“œ ë°¸ëŸ°ì‹± ê¸°ëŠ¥ì„ ì œê³µí•˜ëŠ” ëª¨ë“ˆì„ ì¶”ê°€ì ìœ¼ë¡œ ì„¤ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.

**MetalLB**ëŠ” ë² ì–´ë©”íƒˆ í™˜ê²½ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ë¡œë“œ ë°¸ëŸ°ì„œë¥¼ ì œê³µí•˜ëŠ” ì˜¤í”ˆì†ŒìŠ¤ ì…ë‹ˆë‹¤.

## MetalLB ì„¤ì¹˜ ìš”êµ¬ì‚¬í•­

---

| ìš”êµ¬ ì‚¬í•­                                                                           | ë²„ì „ ë° ë‚´ìš©                                                     |
| ----------------------------------------------------------------------------------- | ---------------------------------------------------------------- |
| Kubernetes                                                                          | ë¡œë“œ ë²¨ëŸ°ì‹± ê¸°ëŠ¥ì´ ì—†ëŠ” >= v1.13.0                               |
| [í˜¸í™˜ê°€ëŠ¥í•œ ë„¤íŠ¸ì›Œí¬ CNI](https://metallb.universe.tf/installation/network-addons/) | Calico, Canal, Cilium, Flannel, Kube-ovn, Kube-router, Weave Net |
| IPv4 ì£¼ì†Œ                                                                           | MetalLB ë°°í¬ì— ì‚¬ìš©                                              |
| BGP ëª¨ë“œë¥¼ ì‚¬ìš©í•  ê²½ìš°                                                              | BGP ê¸°ëŠ¥ì„ ì§€ì›í•˜ëŠ” í•˜ë‚˜ ì´ìƒì˜ ë¼ìš°í„°                           |
| ë…¸ë“œ ê°„ í¬íŠ¸ TCP/UDP 7946 ì˜¤í”ˆ                                                      | memberlist ìš”êµ¬ ì‚¬í•­                                             |

ğŸ’¡ BGPëª¨ë“œê°€ ì•„ë‹Œ Layer2ëª¨ë“œë¥¼ ì‚¬ìš©í•  ê²ƒì´ë©°, ì¶”ê°€ë¡œ ì„¤ì¹˜í•˜ê±°ë‚˜ ì¤€ë¹„í•  ê²ƒì€ ì—†ì—ˆìŠµë‹ˆë‹¤.

## MetalLB ì„¤ì¹˜

---

### Preparation

IPVS ëª¨ë“œì—ì„œ kube-proxyë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš° K8s v1.14.2 ì´í›„ë¶€í„°ëŠ” ì—„ê²©í•œ ARP(strictARP)ëª¨ë“œë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.

ì €í¬ê°€ ì‚¬ìš©í•˜ëŠ” í™˜ê²½ì€ v1.21.7ë¡œ, ARP ëª¨ë“œë¥¼ ì ìš©í•©ë‹ˆë‹¤.

```bash
# í˜„ì¬ ëª¨ë“œ í™•ì¸
kubectl get configmap kube-proxy -n kube-system -o yaml | \
grep strictARP
```

```bash
strictARP: false
```

falseë¡œ ë˜ì–´ìˆëŠ” ê²½ìš° trueë¡œ ë³€ê²½í•˜ê² ìŠµë‹ˆë‹¤.

```bash
# actually apply the changes, returns nonzero returncode on errors only
kubectl get configmap kube-proxy -n kube-system -o yaml | \
sed -e "s/strictARP: false/strictARP: true/" | \
kubectl apply -f - -n kube-system
```

```bash
Warning: resource configmaps/kube-proxy is missing the kubectl.kubernetes.io/last-applied-configuration annotation which is required by kubectl apply. kubectl apply should only be used on resources created declaratively by either kubectl create --save-config or kubectl apply. The missing annotation will be patched automatically.
configmap/kube-proxy configured
```

### ì„¤ì¹˜ - Manifest

```bash
kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.11.0/manifests/namespace.yaml
kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.11.0/manifests/metallb.yaml

# ì •ìƒì ìœ¼ë¡œ ì„¤ì¹˜ë˜ì—ˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤. 2ê°œì˜ podê°€ ëª¨ë‘ Runningì´ ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼
kubectl get pod -n metallb-system
```

```bash
NAME                          READY   STATUS    RESTARTS   AGE
controller-7dcc8764f4-8n92q   1/1     Running   1          1m
speaker-fnf8l                 1/1     Running   1          1m
```

- **controller** : deploymentë¡œ ë°°í¬ë˜ë©°, ë¡œë“œ ë°¸ëŸ°ì‹±ì„ ìˆ˜í–‰í•  ì™¸ë¶€ IPì£¼ì†Œ í• ë‹¹ì„ ì²˜ë¦¬
- **speaker** : deamonset í˜•íƒœë¡œ ë°°í¬ë˜ë©°, ì™¸ë¶€ íŠ¸ë˜í”½ê³¼ ì„œë¹„ìŠ¤ë¥¼ ì—°ê²°í•´ ë„¤íŠ¸ì›Œí¬ í†µì‹ ì´ ê°€ëŠ¥í•˜ë„ë¡

<aside>
ğŸ’¡ ì„œë¹„ìŠ¤ì—ëŠ” ì»¨íŠ¸ë¡¤ëŸ¬ ë° ìŠ¤í”¼ì»¤ì™€ êµ¬ì„± ìš”ì†Œê°€ ì‘ë™í•˜ëŠ” ë° í•„ìš”í•œ RBAC ì‚¬ìš© ê¶Œí•œì´ í¬í•¨ë©ë‹ˆë‹¤.

</aside>

## Configuration

---

MetalLBì˜ ë¡œë“œ ë°¸ëŸ°ì‹± ì •ì±… ì„¤ì •ì€ configmapì„ ë°°í¬í•˜ì—¬ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

MetalLBì—ì„œ êµ¬ì„±í•  ìˆ˜ ìˆëŠ” ëª¨ë“œëŠ” `Layer2 ëª¨ë“œ` ì™€ `BGP ëª¨ë“œ` ê°€ ìˆìŠµë‹ˆë‹¤.

### Layer 2 Configuration

Layer 2 ëª¨ë“œëŠ” ì‚¬ìš©í•  IPì£¼ì†Œì˜ ëŒ€ì—­ë§Œ ì„¤ì •í•˜ë©´ ë©ë‹ˆë‹¤.

Layer 2 ëª¨ë“œë¥¼ ì‚¬ìš©í•  ê²½ìš° ì›Œì»¤ ë…¸ë“œì˜ ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ì— IPë¥¼ ë°”ì¸ë”© í•˜ì§€ ì•Šì•„ë„ ë©ë‹ˆë‹¤.

â†’ ë¡œì»¬ ë„¤íŠ¸ì›Œí¬ì˜ ARP ìš”ì²­ì— ì§ì ‘ ì‘ë‹µí•´ ì»´í“¨í„°ì˜ MACì£¼ì†Œë¥¼ í´ë¼ì´ì–¸íŠ¸ì— ì œê³µ

- `metallb_config.yaml`

```bash
apiVersion: v1
kind: ConfigMap
metadata:
  namespace: metallb-system
  name: config
data:
  config: |
    address-pools:
    - name: default
      protocol: layer2
      addresses:
      - 192.168.1.87-192.168.1.97 # IP ëŒ€ì—­í­
```

> ìœ„ íŒŒì¼ì€ 192.168.1.87 ~ 192.168.1.97ì˜ IPì— ëŒ€í•œ ì œì–´ ê¶Œí•œì„ ì œê³µí•˜ê³ , Layer 2 ëª¨ë“œë¥¼ êµ¬ì„±í•˜ëŠ” ì„¤ì •
í´ëŸ¬ìŠ¤í„° ë…¸ë“œì™€ í´ë¼ì´ì–¸íŠ¸ ë…¸ë“œê°€ ë¶„ë¦¬ëœ ê²½ìš°, ìœ„ IP ëŒ€ì—­ì´ ë‘ ë…¸ë“œ ëª¨ë‘ ì ‘ê·¼ ê°€ëŠ¥í•œ ëŒ€ì—­ì´ì–´ì•¼ í•©ë‹ˆë‹¤.
> 

```bash
kubectl apply -f metallb_config.yaml
```

```bash
# ì •ìƒì ìœ¼ë¡œ ë°°í¬ë˜ë©´ ì•„ë˜ì™€ ê°™ì€ ë©”ì„¸ì§€ê°€ ì¶œë ¥ë©ë‹ˆë‹¤.
configmap/config created
```

## MetalLB ì‚¬ìš©

---

### Kubeflow Dashboard

kubeflowì˜ ëŒ€ì‹œë³´ë“œë¥¼ ì œê³µí•˜ëŠ” istio-system ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì˜ istio-ingressgateway ì„œë¹„ìŠ¤ íƒ€ì…ì„ ë³€ê²½í•©ë‹ˆë‹¤.

```bash
# í˜„ì¬ ì„œë¹„ìŠ¤íƒ€ì… í™•ì¸
kubectl get svc/istio-ingressgateway -n istio-system
```

```bash
NAME                   TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)                                        AGE
istio-ingressgateway   ClusterIP   10.98.123.79   <none>        15021/TCP,80/TCP,443/TCP,31400/TCP,15443/TCP   4h21m
```

> ì„œë¹„ìŠ¤ì˜ íƒ€ì…ì€ ClusterIPì´ë©°, ì™¸ë¶€ IP ê°’ì€ `none` ì…ë‹ˆë‹¤.
> 

```bash
# íƒ€ì…ì„ LoadBalancerë¡œ ë³€ê²½í•˜ê³  IPì£¼ì†Œ ì…ë ¥ (ë§Œì•½ IPì£¼ì†Œ ì…ë ¥í•˜ì§€ ì•Šì„ ê²½ìš° ìœ„ì—ì„œ ì„¤ì •í•œ IP ì£¼ì†Œí’€ì—ì„œ ë°°ì •)
kubectl edit svc/istio-ingressgateway -n istio-system
```

```yaml
# Please edit the object below. Lines beginning with a '#' will be ignored,
# and an empty file will abort the edit. If an error occurs while saving this file will be
# reopened with the relevant failures.
#
apiVersion: v1
kind: Service
metadata:
  annotations:
    kubectl.kubernetes.io/last-applied-configuration: |
      {"apiVersion":"v1","kind":"Service","metadata":{"annotations":{},"labels":{"app":"istio-ingressgateway","install.operator.istio.io/owning-resource":"unknown","istio":"ingressgateway","istio.io/rev":"default","operator.istio.io/component":"IngressGateways","release":"istio"},"name":"istio-ingressgateway","namespace":"istio-system"},"spec":{"ports":[{"name":"status-port","port":15021,"protocol":"TCP","targetPort":15021},{"name":"http2","port":80,"protocol":"TCP","targetPort":8080},{"name":"https","port":443,"protocol":"TCP","targetPort":8443},{"name":"tcp","port":31400,"protocol":"TCP","targetPort":31400},{"name":"tls","port":15443,"protocol":"TCP","targetPort":15443}],"selector":{"app":"istio-ingressgateway","istio":"ingressgateway"},"type":"NodePort"}}
  creationTimestamp: "2023-11-29T08:38:45Z"
  labels:
    app: istio-ingressgateway
    install.operator.istio.io/owning-resource: unknown
    istio: ingressgateway
    istio.io/rev: default
    operator.istio.io/component: IngressGateways
    release: istio
  name: istio-ingressgateway
  namespace: istio-system
  resourceVersion: "560305"
  uid: 4ba0fce1-69ed-4ef6-ae52-07c8fc2d9b3d
spec:
  clusterIP: 10.98.123.79
  clusterIPs:
  - 10.98.123.79
  externalTrafficPolicy: Cluster
  ipFamilies:
  - IPv4
  ipFamilyPolicy: SingleStack
  ports:
	- name: status-port
    nodePort: 30824
    port: 15021
    protocol: TCP
    targetPort: 15021
  - name: http2
    nodePort: 31277
    port: 80
    protocol: TCP
    targetPort: 8080
  - name: https
    nodePort: 30779
    port: 443
    protocol: TCP
    targetPort: 8443
  - name: tcp
    nodePort: 31259
    port: 31400
    protocol: TCP
    targetPort: 31400
  - name: tls
    nodePort: 31998
    port: 15443
    protocol: TCP
    targetPort: 15443
  selector:
    app: istio-ingressgateway
    istio: ingressgateway
  sessionAffinity: None
  type: LoadBalancer               <------- LoadBalancerë¡œ ë³€ê²½
  loadBalancerIP: 192.168.1.88     <------- ì›í•˜ëŠ” IPì£¼ì†Œ ì…ë ¥
status:
  loadBalancer: {}
```

```bash
# ì ìš©ë˜ì—ˆëŠ”ì§€ í™•ì¸
kubectl get svc/istio-ingressgateway -n istio-system
```

```bash
NAME                   TYPE           CLUSTER-IP     EXTERNAL-IP    PORT(S)                                                                      AGE
istio-ingressgateway   LoadBalancer   10.98.123.79   192.168.1.88   15021:30824/TCP,80:31277/TCP,443:30779/TCP,31400:31259/TCP,15443:31998/TCP   44h
```

> ë§Œì•½, ì™¸ë¶€IPì£¼ì†Œê°€ `none` ìœ¼ë¡œ ì¶œë ¥ëœë‹¤ë©´, ë‹¤ë¥¸ ì„œë¹„ìŠ¤ê°€ í•´ë‹¹ IPì£¼ì†Œë¥¼ ì‚¬ìš©í•˜ê³  ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
{: .prompt-warning }

```bash
kubectl get svc -A
```

ìœ„ ëª…ë ¹ì–´ë¥¼ í†µí•´ ëª¨ë“  ì„œë¹„ìŠ¤ë¥¼ ì¶œë ¥í•˜ê³ , ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” IPëŒ€ì—­í­ ì¤‘ í• ë‹¹ë˜ì§€ ì•Šì€ IPì£¼ì†Œë¡œ ë³€ê²½ í›„ ì €ì¥í•©ë‹ˆë‹¤.

ì €ì¥ í›„ `kubectl get svc/istio-ingressgateway -n istio-system` ì„ í†µí•´ ì™¸ë¶€IP ê°’ì´ ì§€ì •í•œ IPì¸ì§€ í™•ì¸í•©ë‹ˆë‹¤.

ì›¹ ë¸Œë¼ìš°ì €ë¡œ ì ‘ì†ì´ ë˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤. `http://192.168.1.88` ~~(user@example.com, 12341234)~~

### MinIO Dashboard

ìœ„ì™€ ë™ì¼í•œ ë°©ë²•ìœ¼ë¡œ ì§„í–‰í•©ë‹ˆë‹¤.

```bash
# í˜„ì¬ ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
kubectl get svc/minio-service -n kubeflow
```

```bash
NAME            TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE
minio-service   ClusterIP   10.99.88.190   <none>        9000/TCP   5h14m
```

Kubeflow ëŒ€ì‹œë³´ë“œì™€ ë™ì¼í•˜ê²Œ ìˆ˜ì •í•©ë‹ˆë‹¤.(IPì£¼ì†ŒëŠ” ë³€ê²½í•´ì•¼í•¨)

```bash
kubectl edit svc/minio-service -n kubeflow
```

```yaml
# Please edit the object below. Lines beginning with a '#' will be ignored,
# and an empty file will abort the edit. If an error occurs while saving this file will be
# reopened with the relevant failures.
#
apiVersion: v1
kind: Service
metadata:
  annotations:
    kubectl.kubernetes.io/last-applied-configuration: |
      {"apiVersion":"v1","kind":"Service","metadata":{"annotations":{},"labels":{"application-crd-id":"kubeflow-pipelines"},"name":"minio-service","namespace":"kubeflow"},"spec":{"ports":[{"name":"http","port":9000,"protocol":"TCP","targetPort":9000}],"selector":{"app":"minio","application-crd-id":"kubeflow-pipelines"}}}
  creationTimestamp: "2023-11-21T07:55:40Z"
  labels:
    application-crd-id: kubeflow-pipelines
  name: minio-service
  namespace: kubeflow
  resourceVersion: "554411"
  uid: 1c6fd99e-6ee5-4baf-935b-d69a5cf9634c
spec:
  clusterIP: 10.99.88.190
  clusterIPs:
  - 10.99.88.190
  externalTrafficPolicy: Cluster
  ipFamilies:
  - IPv4
  ipFamilyPolicy: SingleStack
  ports:
  - name: http
    nodePort: 31772
    port: 9000
    protocol: TCP
    targetPort: 9000
  selector:
    app: minio
    application-crd-id: kubeflow-pipelines
  sessionAffinity: None
  type: LoadBalancer               <------- LoadBalancerë¡œ ë³€ê²½
  loadBalancerIP: 192.168.1.89     <------- ì›í•˜ëŠ” IPì£¼ì†Œ ì…ë ¥
status:
  loadBalancer: {}
```

```bash
# ì ìš©ë˜ì—ˆëŠ”ì§€ í™•ì¸
kubectl get svc/minio-service -n kubeflow
```

```bash
NAME            TYPE           CLUSTER-IP     EXTERNAL-IP    PORT(S)          AGE
minio-service   LoadBalancer   10.99.88.190   192.168.1.89   9000:31772/TCP   9d
```

ì›¹ ë¸Œë¼ìš°ì €ë¡œ ì ‘ì†ì´ ë˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤. `http://192.168.1.89:9000/` ~~(minio, minio123)~~

### Grafana Dashboard

ìœ„ ê³¼ì •ë“¤ê³¼ ë™ì¼í•©ë‹ˆë‹¤.

```yaml
# í˜„ì¬ ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
kubectl get svc/seldon-core-analytics-grafana -n seldon-system
```

```yaml
NAME                            TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE
seldon-core-analytics-grafana   ClusterIP   10.99.201.117   <none>        80/TCP    94s
```

ìœ„ ê³¼ì •ë“¤ê³¼ ë™ì¼í•˜ê²Œ ìˆ˜ì •í•©ë‹ˆë‹¤.(IPì£¼ì†ŒëŠ” ë³€ê²½)

```yaml
kubectl edit svc/seldon-core-analytics-grafana -n seldon-system
```

```yaml
# Please edit the object below. Lines beginning with a '#' will be ignored,
# and an empty file will abort the edit. If an error occurs while saving this file will be
# reopened with the relevant failures.
#
apiVersion: v1
kind: Service
metadata:
  annotations:
    meta.helm.sh/release-name: seldon-core-analytics
    meta.helm.sh/release-namespace: seldon-system
  creationTimestamp: "2023-11-21T08:12:29Z"
  labels:
    app.kubernetes.io/instance: seldon-core-analytics
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: grafana
    app.kubernetes.io/version: 7.0.3
    helm.sh/chart: grafana-5.1.4
  name: seldon-core-analytics-grafana
  namespace: seldon-system
  resourceVersion: "554665"
  uid: e3e52bd2-3cc6-4cd0-8566-76a22f120547
spec:
  clusterIP: 10.99.201.117
  clusterIPs:
  - 10.99.201.117
  externalTrafficPolicy: Cluster
  ipFamilies:
  - IPv4
  ipFamilyPolicy: SingleStack
  loadBalancerIP: 192.168.1.90
  ports:
  - name: service
    nodePort: 30315
    port: 80
    protocol: TCP
    targetPort: 3000
  selector:
    app.kubernetes.io/instance: seldon-core-analytics
    app.kubernetes.io/name: grafana
  sessionAffinity: None
  type: LoadBalancer
status:
  loadBalancer:
    ingress:
    - ip: 192.168.1.90
```

```yaml
kubectl get svc/seldon-core-analytics-grafana -n seldon-system
```

```bash
NAME                            TYPE           CLUSTER-IP      EXTERNAL-IP    PORT(S)        AGE
seldon-core-analytics-grafana   LoadBalancer   10.99.201.117   192.168.1.90   80:30315/TCP   9d
```

ì›¹ ë¸Œë¼ìš°ì €ë¡œ ì ‘ì†ì´ ë˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤. `http://192.168.1.90/`  ~~(admin, password)~~
