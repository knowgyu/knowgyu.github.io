---
title: "[RTOSê°œë°œ] 4ì¥ ë¶€íŒ…í•˜ê¸°"
author: knowgyu
description: " "
date: 2024-10-06 11:08:14 +0900
math: true
categories: [Embedded System, ì„ë² ë””ë“œ OS ê°œë°œ í”„ë¡œì íŠ¸]
tags: [Embedded System, RTOS, Firmware, OS]
---


![image.png](/assets/img/OS/OS000.jpg){: .w-25}
<br>

**ë³¸ í”„ë¡œì íŠ¸ëŠ” ì´ë§Œìš° ì €ìë‹˜ì˜ "ì„ë² ë””ë“œ OS ê°œë°œ í”„ë¡œì íŠ¸" êµì¬ë¥¼ ë”°ë¼ RTOSë¥¼ ë§Œë“œëŠ” ê²ƒì„ ëª©í‘œë¡œ í•©ë‹ˆë‹¤.**

<br>

***
ë³¸ ì¥ì—ì„œëŠ” ì‹œìŠ¤í…œì˜ ì „ì›ì´ ì¼œì§„ í›„ ì´ˆê¸°í™” ì‘ì—…ì„ ì™„ë£Œí•˜ê³  ëŒ€ê¸° ìƒíƒœ(idle)ì— ë„ë‹¬í•˜ëŠ” **ë¶€íŒ… ê³¼ì •**ì— ëŒ€í•´ ë‹¤ë£¹ë‹ˆë‹¤.

## ì„œë¡  ğŸ“š

***

ì»´í“¨í„°ë¥¼ ì¼°ì„ ë•Œ ìš´ì˜ì²´ì œì˜ í™”ë©´ì´ë‚˜ ë°”íƒ•í™”ë©´ì´ ë‚˜íƒ€ë‚˜ëŠ” ê³¼ì •ì„ ì¼ë°˜ì ìœ¼ë¡œ **ë¶€íŒ…**ì´ë¼ê³  í•©ë‹ˆë‹¤. ğŸ’»

íŒì›¨ì–´ ê´€ì ì—ì„œ ë¶€íŒ…ì€ íŠ¹ì •í•œ ê·œì¹™ì´ ì •í•´ì ¸ ìˆì§€ ì•Šì§€ë§Œ, ì‹œìŠ¤í…œ ì „ì›ì´ ì¼œì§„ í›„ ëª¨ë“  ì´ˆê¸°í™” ì‘ì—…ì„ ì™„ë£Œí•˜ê³  íŒì›¨ì–´ê°€ ëŒ€ê¸° ìƒíƒœì— ë„ë‹¬í•  ë•Œê¹Œì§€ì˜ ê³¼ì •ì„ ì˜ë¯¸í•©ë‹ˆë‹¤. ë˜í•œ, ARM ì½”ì–´ê°€ ë¦¬ì…‹ ìµì…‰ì…˜ í•¸ë“¤ëŸ¬ë¥¼ ëª¨ë‘ ì²˜ë¦¬í•œ í›„, ë³¸ê²©ì ìœ¼ë¡œ C ì–¸ì–´ ì½”ë“œë¡œ ì „í™˜ë˜ê¸° ì§ì „ì˜ ìƒíƒœë„ ë¶€íŒ… ê³¼ì •ì— í¬í•¨ë©ë‹ˆë‹¤.

## ë©”ëª¨ë¦¬ ì„¤ê³„ ğŸ§ 

***

ì‹¤í–‰ íŒŒì¼ì€ ë©”ëª¨ë¦¬ë¥¼ í¬ê²Œ ì„¸ ê°€ì§€ ì˜ì—­ìœ¼ë¡œ ë‚˜ëˆ  ì‚¬ìš©í•©ë‹ˆë‹¤.

1. **text ì˜ì—­:** ì½”ë“œê°€ ìœ„ì¹˜í•˜ë©° ë³€ê²½ì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.
2. **data ì˜ì—­:** ì´ˆê¸°í™”ëœ ì „ì—­ ë³€ìˆ˜ê°€ ì €ì¥ë©ë‹ˆë‹¤.
3. **bss ì˜ì—­:** ì´ˆê¸°í™”ë˜ì§€ ì•Šì€ ì „ì—­ ë³€ìˆ˜ê°€ ì €ì¥ë©ë‹ˆë‹¤. ë¹Œë“œëœ ë°”ì´ë„ˆë¦¬ íŒŒì¼ì—ëŠ” ì‹¬ë²Œê³¼ í¬ê¸° ì •ë³´ë§Œ í¬í•¨ë©ë‹ˆë‹¤.

ì´ì œ **text**, **data**, **bss** ì˜ì—­ì„ ì–´ë–»ê²Œ ë°°ì¹˜í• ì§€ ê³ ë¯¼í•´ì•¼ í•©ë‹ˆë‹¤.

- **ì„ë² ë””ë“œ ì‹œìŠ¤í…œì˜ ë©”ëª¨ë¦¬ ìœ í˜•ì— ë”°ë¥¸ ë°°ì¹˜ ì „ëµ:**
  
  - **ë¹ ë¥¸ ë©”ëª¨ë¦¬:** **text ì˜ì—­** ë° ì¼ë¶€ ì„±ëŠ¥ì— ë¯¼ê°í•œ **data ì˜ì—­**ì„ ë°°ì¹˜í•©ë‹ˆë‹¤.
  - **ìš©ëŸ‰ í° ë©”ëª¨ë¦¬:** ë‚˜ë¨¸ì§€ **data ì˜ì—­**ê³¼ **bss ì˜ì—­**ì„ ë°°ì¹˜í•©ë‹ˆë‹¤.

í•˜ì§€ë§Œ, **QEMU**ëŠ” ì´ëŸ¬í•œ ë©”ëª¨ë¦¬ êµ¬ë¶„ì´ ì—†ìœ¼ë¯€ë¡œ ìˆœì°¨ì ìœ¼ë¡œ ë°°ì¹˜í•˜ê² ìŠµë‹ˆë‹¤.

### Text ì˜ì—­ì˜ í¬ê¸° ì„¤ì • ğŸ“

ë¦¬ëˆ…ìŠ¤ ê°™ì€ ê±°ëŒ€í•œ ìš´ì˜ì²´ì œë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê¸°ì—, RTOSë¥¼ ì‚¬ìš©í•˜ëŠ” íŒì›¨ì–´ëŠ” ë§ì•„ì•¼ ìˆ˜ì‹­ KB ì •ë„ë©´ ì¶©ë¶„í•©ë‹ˆë‹¤.

ë³¸ í”„ë¡œì íŠ¸ì—ì„œëŠ” ë„‰ë„‰í•˜ê²Œ **1MB**ë¥¼ í• ë‹¹í•˜ê² ìŠµë‹ˆë‹¤.

ìµì…‰ì…˜ ë²¡í„° í…Œì´ë¸”ì„ **text ì˜ì—­**ì— í¬í•¨ì‹œí‚¬ ê²ƒì´ë¯€ë¡œ, ì‹œì‘ ì£¼ì†ŒëŠ” `0x0000 0000`ì´ë©°, **1MB**ì´ê¸°ì— ë ì£¼ì†ŒëŠ” `0x000F FFFF`ì…ë‹ˆë‹¤.

### Data ì˜ì—­ê³¼ BSS ì˜ì—­ì˜ í¬ê¸° ì„¤ì • ğŸ“

ë°ì´í„°ì˜ ì„±ê²©ì— ë”°ë¼ ë°ì´í„°ë¥¼ í• ë‹¹í•´ì•¼ í•©ë‹ˆë‹¤.

- **ë°ì´í„°ì˜ í˜•íƒœ:** ë™ì‘ ëª¨ë“œë³„ ìŠ¤íƒ, í…ŒìŠ¤í¬ ìŠ¤íƒ, ì „ì—­ ë³€ìˆ˜, ë™ì  ë©”ëª¨ë¦¬ í• ë‹¹ ì˜ì—­
- **ë°ì´í„°ì˜ ì†ì„±:** ì„±ëŠ¥ ì¤‘ì‹œ ë°ì´í„°, í° ê³µê°„ì´ í•„ìš”í•œ ë°ì´í„°, ê³µìœ  ë°ì´í„°

> - USR, SYS(2MB) : 0x0010 0000 ~ 0x002F FFFF  
> - SVC(1MB) : 0X0030 0000 ~ 0X003F FFFF  
> - IRQ(1MB) â€¦  
> - FIQ(1MB) â€¦  
> - ABT(1MB) â€¦  
> - UND(1MB) â€¦
{: .prompt-info }

ê°œë³„ ë™ì‘ ëª¨ë“œë§ˆë‹¤ ê° **1MB**ì”© í• ë‹¹í–ˆìŠµë‹ˆë‹¤. USRê³¼ SYS ëª¨ë“œëŠ” ë©”ëª¨ë¦¬ ê³µê°„ê³¼ ë ˆì§€ìŠ¤í„°ë¥¼ ëª¨ë‘ ê³µìœ í•˜ê¸°ì— í•˜ë‚˜ë¡œ ë¬¶ì–´ **2MB**ë¥¼ í• ë‹¹í–ˆìŠµë‹ˆë‹¤.

RTOSë¥¼ ê°œë°œí•  ê²ƒì´ê¸°ì— RTOS ìœ„ì—ì„œ ë™ì‘í•  **í…ŒìŠ¤í¬(Task) ìŠ¤íƒ ì˜ì—­**ë„ ê³ ë ¤í•´ì•¼ í•©ë‹ˆë‹¤. í…ŒìŠ¤í¬ë§ˆë‹¤ ê° **1MB**ì”© í• ë‹¹í•  ê³„íšì´ë¯€ë¡œ ì´ **64MB**ë¥¼ ë°°ì •í•˜ê² ìŠµë‹ˆë‹¤.

â†’ ë³¸ í”„ë¡œì íŠ¸ì˜ RTOSëŠ” ìµœëŒ€ **64ê°œ**ì˜ í…ŒìŠ¤í¬ë¥¼ ì§€ì›í•˜ê²Œ ë©ë‹ˆë‹¤.

- **ë©”ëª¨ë¦¬ ì„¤ê³„**

![ë©”ëª¨ë¦¬ ì„¤ê³„](/assets/img/OS/os301.png)

## ìµì…‰ì…˜ ë²¡í„° í…Œì´ë¸” ë§Œë“¤ê¸° ğŸ› ï¸

***

ì„¤ê³„ë¥¼ ì™„ë£Œí•œ í›„, **ìµì…‰ì…˜ í•¸ë“¤ëŸ¬**ë¥¼ ì½”ë“œë¡œ êµ¬í˜„í•˜ê² ìŠµë‹ˆë‹¤.

### ìµì…‰ì…˜ ë²¡í„° í…Œì´ë¸” ì´ˆê¸° ì½”ë“œ `Entry.S` ğŸ“„

```bash
.text
	.code 32

	.global vector_start
	.global vector_end

	vector_start:
		LDR		PC, reset_handler_addr
		LDR		PC, undef_handler_addr
		LDR		PC, svc_handler_addr
		LDR		PC, pftch_abt_handler_addr
		LDR		PC, data_abt_handler_addr
		B		.
		LDR		PC, irq_handler_addr
		LDR		PC, fiq_handler_addr

		reset_handler_addr: 	.word reset_handler
		undef_handler_addr: 	.word dummy_handler
		svc_handler_addr: 		.word dummy_handler
		pftch_abt_handler_addr: .word dummy_handler
		data_abt_handler_addr:  .word dummy_handler
		irq_handler_addr:		.word dummy_handler
		fiq_handler_addr:		.word dummy_handler
	vector_end:

	reset_handler:
		LDR		R0, =0x10000000
		LDR		R1, [R0]

	dummy_handler:
		B .
.end
```

> ë¶™ì—¬ë„£ê¸° ì‹œ vi ëª…ë ¹ì–´ë¡œ `:set paste` í›„ ë¶™ì—¬ë„£ìœ¼ë©´ ë“¤ì—¬ì“°ê¸° ì˜¤ë¥˜ë¥¼ ë°©ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
{: .prompt-info }

ìš°ì„ , ê° í•¸ë“¤ëŸ¬ë¡œ ì í”„í•˜ëŠ” ì½”ë“œë§Œ ì‘ì„±í•˜ê³ , í•¸ë“¤ëŸ¬ëŠ” ì‘ì„±í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.

ë¦¬ì…‹ ìµì…‰ì…˜ í•¸ë“¤ëŸ¬ì—ëŠ” `SYS_ID`ë¥¼ ì½ëŠ” ì½”ë“œê°€ ìˆìœ¼ë¯€ë¡œ, 3ì¥ì—ì„œì™€ ê°™ì´ `R0`ê³¼ `R1`ì— ê°’ì´ ìˆëŠ”ì§€ í™•ì¸í•˜ê³ , ì½”ë“œë¥¼ ì´ì–´ì„œ ì‘ì„±í•˜ê² ìŠµë‹ˆë‹¤.

```bash
$ make debug
...
$ make gdb
...
(gdb) target remote:1234
(gdb) continue

^C  # ë¬´í•œë£¨í”„ë¥¼ ëŒê³  ìˆìœ¼ë¯€ë¡œ, Ctrl + Cë¥¼ ì´ìš©í•´ ë¹ ì ¸ë‚˜ì˜µë‹ˆë‹¤.
(gdb) i r
```

![ë””ë²„ê¹… ì´ë¯¸ì§€](/assets/img/OS/os302.png)

ì´ì „ 3.5ì ˆì—ì„œ í™•ì¸í•œ ê²°ê³¼ì™€ ê°™ìŠµë‹ˆë‹¤.

## ìµì…‰ì…˜ í•¸ë“¤ëŸ¬ ë§Œë“¤ê¸° ğŸ”§

***

í•¸ë“¤ëŸ¬ë¥¼ ì‘ì„±í•˜ê¸° ì „ì—, **ìµì…‰ì…˜ í•¸ë“¤ëŸ¬**ì™€ **ë±…í¬ë“œ ë ˆì§€ìŠ¤í„°**ì— ëŒ€í•œ ARM ì•„í‚¤í…ì²˜ì˜ ê°œë…ì„ ìˆ™ì§€í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.

ê°€ì¥ ë¨¼ì € ì‘ì„±í•  í•¸ë“¤ëŸ¬ëŠ” **ë¦¬ì…‹ ìµì…‰ì…˜ í•¸ë“¤ëŸ¬**ì…ë‹ˆë‹¤. ì´ í•¸ë“¤ëŸ¬ëŠ” ë©”ëª¨ë¦¬ ë§µì„ ì„¤ì •í•˜ê³ , ë™ì‘ ëª¨ë“œë³„ ìŠ¤íƒ ì£¼ì†Œë¥¼ **SP ë ˆì§€ìŠ¤í„°**ì— í• ë‹¹í•©ë‹ˆë‹¤. ëª¨ë“  ìŠ¤íƒ ì„¤ì •ì´ ì™„ë£Œë˜ë©´ C ì–¸ì–´ì˜ `main()` í•¨ìˆ˜ë¡œ ì§„ì…í•˜ì—¬ **C ì–¸ì–´ë¡œ ì„ë² ë””ë“œ ì‹œìŠ¤í…œì„ ì œì–´**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ARMì€ ì´ **7ê°œì˜ ë™ì‘ ëª¨ë“œ**ê°€ ìˆìœ¼ë©°, USRê³¼ SYS ëª¨ë“œëŠ” ë ˆì§€ìŠ¤í„°ë¥¼ ê³µìœ í•˜ì—¬ **6ê°œì˜ SP ë ˆì§€ìŠ¤í„°**ê°€ ì œê³µë©ë‹ˆë‹¤.

### ìŠ¤íƒ ë§Œë“¤ê¸° ğŸ§©

ì´ì „ ì ˆì—ì„œ ì„¤ê³„í•œ ë©”ëª¨ë¦¬ ë§µì„ C ì–¸ì–´ ì½”ë“œë¡œ êµ¬í˜„í•©ë‹ˆë‹¤.

### ìŠ¤íƒ ì£¼ì†Œë¥¼ ì •ì˜ `MemoryMap.h` ğŸ“

```bash
#define INST_ADDR_START     0
#define USRSYS_STACK_START  0x00100000
#define SVC_STACK_START     0x00300000
#define IRQ_STACK_START     0x00400000
#define FIQ_STACK_START     0x00500000
#define ABT_STACK_START     0x00600000
#define UND_STACK_START     0x00700000
#define TASK_STACK_START    0x00800000
#define GLOBAL_ADDR_START   0x04800000
#define DALLOC_ADDR_START   0x04900000

#define INST_MEM_SIZE       (USRSYS_STACK_START - INST_ADDR_START)
#define USRSYS_STACK_SIZE   (SVC_STACK_START - USRSYS_STACK_START)
#define SVC_STACK_SIZE      (IRQ_STACK_START - SVC_STACK_START)
#define IRQ_STACK_SIZE      (FIQ_STACK_START - IRQ_STACK_START)
#define FIQ_STACK_SIZE      (ABT_STACK_START - FIQ_STACK_START)
#define ABT_STACK_SIZE      (UND_STACK_START - ABT_STACK_START)
#define UND_STACK_SIZE      (TASK_STACK_START - UND_STACK_START)
#define TASK_STACK_SIZE     (GLOBAL_ADDR_START - TASK_STACK_START)
#define DALLOC_MEM_SIZE     (55 * 1024 * 1024)

#define USRSYS_STACK_TOP    (USRSYS_STACK_START + USRSYS_STACK_SIZE - 4)
#define SVC_STACK_TOP       (SVC_STACK_START + SVC_STACK_SIZE - 4)
#define IRQ_STACK_TOP       (IRQ_STACK_START + IRQ_STACK_SIZE - 4)
#define FIQ_STACK_TOP       (FIQ_STACK_START + FIQ_STACK_SIZE - 4)
#define ABT_STACK_TOP       (ABT_STACK_START + ABT_STACK_SIZE - 4)
#define UND_STACK_TOP       (UND_STACK_START + UND_STACK_SIZE - 4)
```

ìœ„ ì½”ë“œëŠ” C ì–¸ì–´ í—¤ë” íŒŒì¼ì´ì§€ë§Œ, GCCë¡œ ì»´íŒŒì¼í•˜ë©´ `Entry.S` ì–´ì…ˆë¸”ë¦¬ì–´ íŒŒì¼ì—ì„œë„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ê·¸ë¦¬ê³ , ARMì˜ `cspr`ì— ê°’ì„ ì„¤ì •í•´ ë™ì‘ ëª¨ë“œë¥¼ ë³€ê²½í•  ìˆ˜ ìˆëŠ” ê°’ì„ ì •ì˜í•œ í—¤ë” íŒŒì¼ì„ ë§Œë“¤ê² ìŠµë‹ˆë‹¤.

### ë™ì‘ ëª¨ë“œ ì „í™˜ ê°’ `ARMv7AR.h` ğŸ”„

```bash
/* PSR Mode Bit Values */
#define ARM_MODE_BIT_USR 0x10
#define ARM_MODE_BIT_FIQ 0x11
#define ARM_MODE_BIT_IRQ 0x12
#define ARM_MODE_BIT_SVC 0x13
#define ARM_MODE_BIT_ABT 0x17
#define ARM_MODE_BIT_UND 0x1B
#define ARM_MODE_BIT_SYS 0x1F
#define ARM_MODE_BIT_MON 0x16
```

í—¤ë” íŒŒì¼ì„ ì–´ì…ˆë¸”ë¦¬ì–´ ì½”ë“œì— í¬í•¨ì‹œí‚µë‹ˆë‹¤.

### ë™ì‘ ëª¨ë“œ ìŠ¤íƒ ì´ˆê¸°í™” ë¦¬ì…‹ ìµì…‰ì…˜ í•¸ë“¤ëŸ¬ `Entry.S` ğŸ“

```bash
#include "ARMv7AR.h"
#include "MemoryMap.h"

.text
    .code 32

    .global vector_start
    .global vector_end

    vector_start:
        LDR PC, reset_handler_addr
        LDR PC, undef_handler_addr
        LDR PC, svc_handler_addr
        LDR PC, pftch_abt_handler_addr
        LDR PC, data_abt_handler_addr
        B   .
        LDR PC, irq_handler_addr
        LDR PC, fiq_handler_addr

        reset_handler_addr:     .word reset_handler
        undef_handler_addr:     .word dummy_handler
        svc_handler_addr:       .word dummy_handler
        pftch_abt_handler_addr: .word dummy_handler
        data_abt_handler_addr:  .word dummy_handler
        irq_handler_addr:       .word dummy_handler
        fiq_handler_addr:       .word dummy_handler
    vector_end:

    reset_handler:
        MRS r0, cpsr
        BIC r1, r0, #0x1F
        ORR r1, r1, #ARM_MODE_BIT_SVC
        MSR cpsr, r1
        LDR sp, =SVC_STACK_TOP

        MRS r0, cpsr
        BIC r1, r0, #0x1F
        ORR r1, r1, #ARM_MODE_BIT_IRQ
        MSR cpsr, r1
        LDR sp, =IRQ_STACK_TOP

        MRS r0, cpsr
        BIC r1, r0, #0x1F
        ORR r1, r1, #ARM_MODE_BIT_FIQ
        MSR cpsr, r1
        LDR sp, =FIQ_STACK_TOP

        MRS r0, cpsr
        BIC r1, r0, #0x1F
        ORR r1, r1, #ARM_MODE_BIT_ABT
        MSR cpsr, r1
        LDR sp, =ABT_STACK_TOP

        MRS r0, cpsr
        BIC r1, r0, #0x1F
        ORR r1, r1, #ARM_MODE_BIT_UND
        MSR cpsr, r1
        LDR sp, =UND_STACK_TOP

        MRS r0, cpsr
        BIC r1, r0, #0x1F
        ORR r1, r1, #ARM_MODE_BIT_SYS
        MSR cpsr, r1
        LDR sp, =USRSYS_STACK_TOP

    dummy_handler:
        B .
.end
```

> í—¤ë” íŒŒì¼ì˜ ìœ„ì¹˜ë¥¼ ì–´ì…ˆë¸”ëŸ¬ì— ì•Œë ¤ì£¼ì§€ ì•Šìœ¼ë©´ ì‹¬ë²Œ ì •ì˜ ì˜¤ë¥˜ê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
{: .prompt-info }

### Makefile ìˆ˜ì • ğŸ› ï¸

í—¤ë” íŒŒì¼ ê²½ë¡œë¥¼ ì§€ì •í•˜ì—¬ ì»´íŒŒì¼ ì˜¤ë¥˜ë¥¼ ë°©ì§€í•©ë‹ˆë‹¤.

```bash
ARCH = armv7-a
MCPU = cortex-a8

CC = arm-none-eabi-gcc
AS = arm-none-eabi-as
LD = arm-none-eabi-ld
OC = arm-none-eabi-objcopy

LINKER_SCRIPT = ./navilos.ld

ASM_SRCS = $(wildcard boot/*.S)
ASM_OBJS = $(patsubst boot/%.S, build/%.o, $(ASM_SRCS))

INC_DIRS = include # í—¤ë”íŒŒì¼ì´ ìˆëŠ” ë””ë ‰í† ë¦¬ë¥¼ ì§€ì •

navilos = build/navilos.axf
navilos_bin = build/navilos.bin

.PHONY: all clean run debug gdb

all: $(navilos)

clean:
	@rm -fr build
	
run: $(navilos)
	qemu-system-arm -M realview-pb-a8 -kernel $(navilos)
	
debug: $(navilos)
	qemu-system-arm -M realview-pb-a8 -kernel $(navilos) -S -gdb tcp::1234,ipv4
	
gdb:
	gdb-multiarch $(navilos)
	
$(navilos): $(ASM_OBJS) $(LINKER_SCRIPT)
	$(LD) -n -T $(LINKER_SCRIPT) -o $(navilos) $(ASM_OBJS)
	$(OC) -O binary $(navilos) $(navilos_bin)
	
build/%.o: boot/%.S
	mkdir -p $(shell dirname $@)
	$(CC) -march=$(ARCH) -mcpu=$(MCPU) -I $(INC_DIRS) -c -g -o $@ $< # -I ì˜µì…˜ìœ¼ë¡œ ì¶”ê°€í•˜ê³ , $(AS)ë¥¼ $(CC)ë¡œ ìˆ˜ì •
```

> `#define`ì€ ì „ì²˜ë¦¬ê¸°ì— ì˜í•´ ì²˜ë¦¬ë˜ëŠ”ë°, `arm-none-eabi-as`ëŠ” ì–´ì…ˆë¸”ëŸ¬ì¼ ë¿ ì „ì²˜ë¦¬ë¥¼ ì§€ì›í•˜ì§€ ì•Šê¸°ì—, ì „ì²˜ë¦¬ê¹Œì§€ ì§„í–‰í•˜ë ¤ë©´ `gcc`ë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤. <br>â†’ `$(AS)`ì—ì„œ `$(CC)`ë¡œ ìˆ˜ì •
{: .prompt-info }

`$(CC)`ë¡œ ìˆ˜ì •í•˜ì—¬ GCCë¥¼ ì‚¬ìš©í•¨ìœ¼ë¡œì¨, `-c` ì˜µì…˜ì„ ì¶”ê°€í•´ ì˜¤ë¸Œì íŠ¸ íŒŒì¼ì„ ìƒì„±í•˜ë„ë¡ ì§€ì‹œí•©ë‹ˆë‹¤.

### ìŠ¤íƒ í™•ì¸í•˜ê¸° ğŸ§

ë¹Œë“œë¥¼ ì™„ë£Œí–ˆìœ¼ë‹ˆ, ì´ì œ ìŠ¤íƒì´ ì œëŒ€ë¡œ ì´ˆê¸°í™”ë˜ì—ˆëŠ”ì§€ í™•ì¸í•´ ë³´ê² ìŠµë‹ˆë‹¤.

ë³€ìˆ˜ë‚˜ ë ˆì§€ìŠ¤í„°ì˜ ê°’ì„ ì¶œë ¥í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ, **gdb**ë¥¼ ì´ìš©í•´ í™•ì¸í•©ë‹ˆë‹¤.

```bash
(gdb) target remote:1234
.
(gdb) s
.
(gdb) s
.
(gdb) s
.
(gdb) s
.
(gdb) s
.
(gdb) s
.
(gdb) i r
r0             0x400001d3          1073742291
r1             0x400001d3          1073742291
r2             0x0                 0
r3             0x0                 0
...
```

![ìŠ¤íƒ í™•ì¸ ì´ë¯¸ì§€](/assets/img/OS/os303.png)

34ë²ˆì§¸ ì¤„ê¹Œì§€ ì‹¤í–‰ë˜ë©´ ì²« ë²ˆì§¸ SVC ë™ì‘ ëª¨ë“œ ìŠ¤íƒì´ ì„¤ì •ë©ë‹ˆë‹¤.

ì´ì „ SVC ëª¨ë“œ ìŠ¤íƒì€ `0x0030 0000 ~ 0x003F FFFF`ê¹Œì§€ì˜ ë©”ëª¨ë¦¬ ì£¼ì†Œ ì˜ì—­ì„ ê°€ì§‘ë‹ˆë‹¤.

ë˜í•œ, ìŠ¤íƒê³¼ ìŠ¤íƒ ê²½ê³„ ì‚¬ì´ì— **4ë°”ì´íŠ¸**ë¥¼ ë¹„ì›Œë‘ë„ë¡ í¬ê¸°ë¥¼ ì„¤ì •í–ˆìœ¼ë¯€ë¡œ, ìŠ¤íƒ í¬ì¸í„°ì— ì €ì¥ë˜ì–´ì•¼ í•  ê°’ì€ `0x003F FFFC`ì…ë‹ˆë‹¤.

ìœ„ ì´ë¯¸ì§€ë¥¼ ë³´ë©´ `sp 0x3f fffc`ë¼ëŠ” ì¶œë ¥ì´ ë³´ì…ë‹ˆë‹¤. ë‚˜ë¨¸ì§€ ê°’ë“¤ë„ í™•ì¸í•´ë³´ë©´, ê°’ì´ ì œëŒ€ë¡œ ì„¤ì •ë˜ì—ˆìŒì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

> SYS ë™ì‘ ëª¨ë“œë¥¼ ê°€ì¥ ë§ˆì§€ë§‰ì— ì„¤ì •í–ˆìŠµë‹ˆë‹¤. ìŠ¤íƒ ì„¤ì •ì„ ì™„ë£Œí•˜ë©´ RTOSë¡œ ì§„ì…í•˜ê²Œ ë˜ëŠ”ë°, RTOSì™€ íŒì›¨ì–´ì˜ ê¸°ë³¸ ë™ì‘ ëª¨ë“œê°€ SYSì´ê¸°ì—, ì¶”ê°€ ì„¤ì • ì—†ì´ SYS ëª¨ë“œë¡œ ì‘ì—…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
{: .prompt-info }

## ë©”ì¸ìœ¼ë¡œ ì§„ì…í•˜ê¸° ğŸ¯

***

C ì–¸ì–´ì˜ ì‹œì‘ ì§€ì ì€ ì¼ë°˜ì ìœ¼ë¡œ `main()` í•¨ìˆ˜ì…ë‹ˆë‹¤. ì»´íŒŒì¼ëŸ¬ê°€ ê¸°ë³¸ì ìœ¼ë¡œ `main()`ì„ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì—, ì´ë¥¼ ìœ ì§€í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.

### ë©”ì¸ í•¨ìˆ˜ë¡œ ì í”„í•˜ëŠ” ì½”ë“œ ì¶”ê°€ `Entry.S` ğŸ”„

```bash
...(ìƒëµ)
        MRS r0, cpsr
        BIC r1, r0, #0x1F
        ORR r1, r1, #ARM_MODE_BIT_SYS
        MSR cpsr, r1
        LDR sp, =USRSYS_STACK_TOP
                
                BL main     # ì´ê±° ì¶”ê°€
```

ì´ í•œ ì¤„ë¡œ ì–´ì…ˆë¸”ë¦¬ì–´ ì½”ë“œì—ì„œ C ì–¸ì–´ ì½”ë“œë¡œ ì „í™˜ë©ë‹ˆë‹¤.

ì´ì œ, `boot/Main.c` íŒŒì¼ì„ ë§Œë“¤ê³  ê°„ë‹¨í•œ ì½”ë“œë¥¼ ì‘ì„±í•´ë³´ê² ìŠµë‹ˆë‹¤.

### Main.c íŒŒì¼ ì´ˆê¸° ì½”ë“œ ğŸ–¥ï¸

```bash
#include "stdint.h"

void main(void){
	uint32_t* dummyAddr = (uint32_t*)(1024*1024*100);
	*dummyAddr = sizeof(long);
}
```

ì–´ì…ˆë¸”ë¦¬ì–´ ì½”ë“œì—ì„œ ë¸Œëœì¹˜ ëª…ë ¹(`BL`)ìœ¼ë¡œ ì í”„ë¥¼ í•˜ë ¤ë©´, ì í”„ ëŒ€ìƒ ë ˆì´ë¸”ì´ ë™ì¼ íŒŒì¼ì— ìˆì–´ì•¼ í•©ë‹ˆë‹¤.

ë‹¤ë¥¸ íŒŒì¼ì— ìˆë‹¤ë©´ ë§ì»¤ê°€ ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ ë ˆì´ë¸”ì„ `.global`ë¡œ ì„ ì–¸í•´ì•¼ í•©ë‹ˆë‹¤.

**ì»´íŒŒì¼ëŸ¬**ëŠ” C ì–¸ì–´ í•¨ìˆ˜ ì´ë¦„ì„ ë§ì»¤ê°€ ìë™ìœ¼ë¡œ ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ì „ì—­ ì‹¬ë²Œë¡œ ë§Œë“­ë‹ˆë‹¤.

> ì „ì—­ ì‹¬ë²Œì€ ì–´ì…ˆë¸”ë¦¬ì–´ì—ì„œ `.global`ì´ê³ , C ì–¸ì–´ì—ì„œëŠ” `extern`ìœ¼ë¡œ ì„ ì–¸ëœ ì´ë¦„ì…ë‹ˆë‹¤.  
> 
> ë°˜ëŒ€ë¡œ ì–´ì…ˆë¸”ë¦¬ì–´ì—ì„œ `.global`ë¡œ ì„ ì–¸í•œ ì´ë¦„ì€ C ì–¸ì–´ì—ì„œ í•¨ìˆ˜ í˜¸ì¶œë¡œ ì§„ì…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
{: .prompt-info }

ìœ„ `Main.c` íŒŒì¼ì€ **100MB ë©”ëª¨ë¦¬ ì£¼ì†Œ ì˜ì—­(0x640 0000)**ì— ì˜ë¯¸ ì—†ëŠ” ê°’ì„ ì“°ëŠ” ë™ì‘ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.

ìœ„ ì½”ë“œì—ì„œëŠ” `long` íƒ€ì…ì˜ í¬ê¸°ì¸ **4**ë¥¼ ë©”ëª¨ë¦¬ì— ì €ì¥í•©ë‹ˆë‹¤. 32ë¹„íŠ¸ ARM ë¨¸ì‹ ì´ë¯€ë¡œ ìˆ«ì **4**ê°€ ë©”ëª¨ë¦¬ì— ì €ì¥ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.

### C ì–¸ì–´ íŒŒì¼ì„ ì»´íŒŒì¼í•˜ê¸° ìœ„í•œ Makefile ğŸ“„

```bash
ARCH = armv7-a
MCPU = cortex-a8

CC = arm-none-eabi-gcc
AS = arm-none-eabi-as
LD = arm-none-eabi-ld
OC = arm-none-eabi-objcopy

LINKER_SCRIPT = ./navilos.ld
MAP_FILE = build/navilos.map

ASM_SRCS = $(wildcard boot/*.S)
ASM_OBJS = $(patsubst boot/%.S, build/%.os, $(ASM_SRCS))

C_SRCS = $(wildcard boot/*.c)
C_OBJS = $(patsubst boot/%.c, build/%.o, $(C_SRCS))

INC_DIRS  = -I include

navilos = build/navilos.axf
navilos_bin = build/navilos.bin

.PHONY: all clean run debug gdb

all: $(navilos)

clean:
	@rm -fr build
	
run: $(navilos)
	qemu-system-arm -M realview-pb-a8 -kernel $(navilos)
	
debug: $(navilos)
	qemu-system-arm -M realview-pb-a8 -kernel $(navilos) -S -gdb tcp::1234,ipv4
	
gdb:
	gdb-multiarch $(navilos)
	
$(navilos): $(ASM_OBJS) $(C_OBJS) $(LINKER_SCRIPT)
	$(LD) -n -T $(LINKER_SCRIPT) -o $(navilos) $(ASM_OBJS) $(C_OBJS) -Map=$(MAP_FILE)
	$(OC) -O binary $(navilos) $(navilos_bin)
	
build/%.os: boot/%.S
	mkdir -p $(shell dirname $@)
	$(CC) -march=$(ARCH) -mcpu=$(MCPU) $(INC_DIRS) -c -g -o $@ $<
	
build/%.o: boot/%.c
	mkdir -p $(shell dirname $@)
	$(CC) -march=$(ARCH) -mcpu=$(MCPU) $(INC_DIRS) -c -g -o $@ $<
```

ë¨¼ì € **10ë²ˆì§¸ ì¤„**ì—ì„œ map íŒŒì¼ ì´ë¦„ì„ ì§€ì •í–ˆìŠµë‹ˆë‹¤. (`map` íŒŒì¼ì€ ë§ì»¤ê°€ ìƒì„±í•˜ëŠ” íŒŒì¼ì…ë‹ˆë‹¤.)

C ì–¸ì–´ ì†ŒìŠ¤ì½”ë“œì™€ ì˜¤ë¸Œì íŠ¸ íŒŒì¼ì„ ë³€ìˆ˜ë¡œ ì§€ì •í•œ í›„, ë§ì»¤ì— íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬í•©ë‹ˆë‹¤.

ë§ˆì§€ë§‰ `build/%.o`ì—ì„œ C ì–¸ì–´ íŒŒì¼ì„ ì»´íŒŒì¼í•´ ì˜¤ë¸Œì íŠ¸ íŒŒì¼ì„ ìƒì„±í•˜ëŠ” ë§¤í¬ë¡œë¥¼ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.

### ğŸ’¡ `stdint.h` íŒŒì¼ ì¶”ê°€ í•„ìš” ğŸ“„

```c
/* stdint.h ë‚´ìš© (ìƒëµ) */
```

ë¹Œë“œ í›„ **gdb**ë¡œ **100MB ìœ„ì¹˜(0x640 0000)**ì˜ ë©”ëª¨ë¦¬ ê°’ì„ í™•ì¸í•©ë‹ˆë‹¤.

![ë©”ëª¨ë¦¬ ê°’ í™•ì¸ ì´ë¯¸ì§€](/assets/img/OS/os305.png)

`x/8wx ë©”ëª¨ë¦¬ ì£¼ì†Œ` ëª…ë ¹ì–´ë¡œ ë©”ëª¨ë¦¬ ê°’ì„ í™•ì¸í•œ ê²°ê³¼, **4**ê°€ ì •ìƒì ìœ¼ë¡œ ì €ì¥ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## ìš”ì•½ ğŸ“

***

ì´ë²ˆ ì¥ì—ì„œëŠ” ì‹œìŠ¤í…œì˜ ì „ì›ì´ ì¼œì¡Œì„ ë•Œì˜ **ë¶€íŒ… ê³¼ì •**ê³¼ íŒì›¨ì–´ ì´ˆê¸°í™” ì½”ë“œë¥¼ ì‘ì„±í•˜ì˜€ìŠµë‹ˆë‹¤.

ARM í”„ë¡œì„¸ì„œì˜ ì´ˆê¸° ì§„ì… ì½”ë“œë¥¼ êµ¬í˜„í•˜ê³ , ì•ìœ¼ë¡œ ë§Œë“¤ **ë‚˜ë¹Œë¡œìŠ¤(Navilos)**ì˜ ë©”ëª¨ë¦¬ ë§µì„ êµ¬ì„±í•˜ì˜€ìŠµë‹ˆë‹¤.

ë‹¤ìŒ ì¥ì—ì„œëŠ” í•˜ë“œì›¨ì–´ ì¤‘ **UART**ë¥¼ ì œì–´í•˜ì—¬ **gdb**ê°€ ì•„ë‹Œ **í„°ë¯¸ë„ í™”ë©´**ê³¼ì˜ ìƒí˜¸ì‘ìš©ì„ êµ¬í˜„í•  ì˜ˆì •ì…ë‹ˆë‹¤.

***


## ì°¸ê³ 
***

ì°¸ê³  ê¹ƒí—ˆë¸Œ : [https://github.com/navilera/Navilos](https://github.com/navilera/Navilos)

ì´ë§Œìš° ì €ìë‹˜ì˜ ë¸”ë¡œê·¸ ì£¼ì†Œ : [https://kldp.org/node/162560](https://kldp.org/node/162560)
